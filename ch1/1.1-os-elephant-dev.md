## 前言

本教程用于学习龙芯结构，并进行编程实践。所说的龙芯架构包含了 loongarch 架构，以及龙芯CPU与系统之间的规范。讲述方式是将os-elephant-dev操作系统移植到龙芯架构上，在移植的过程中逐渐理解龙芯架构。选用的操作系统是比较容易上手的操作系统，其使用C语言完成开发，并有配套的书籍详细描述细节。所以移植的过程中涉及到架构相关的内容会展开进行讲述，系统相关的内容会大致进行描述，在系统相关代码不影响理解的情况下深入理解龙芯架构。

本教程在ubuntu20.04系统下，选用QEMU模拟龙芯硬件环境进行开发，模拟的CPU型号为3A5000，桥片为7A1000。提到3A5000和7A1000可能会有点迷惑，所以先介绍一下3A5000和7A1000，这样能够先大致了解龙芯。在介绍玩3A5000和7A1000后再简单介绍一下os-elephant-dev操作系统，并在bochs模拟器中运行x86架构的os-elephant-dev。

## 1 os-elephant-dev简介

os-elephant-dev是《操作系统-真相还原》配套的操作系统，该书详细描述了如何实现该操作系统。该系统实现了中断、内存管理、线程、用户进程、磁盘驱动、文件系统和一些系统调用，包含了操作系统中的各个模块。接下来运行一下os-elephant-dev操作系统，本节的作用是建立代码基本结构，并且对系统有个大致认识。

使用bochs运行x86架构的os-elephant-dev操作系统。在qemu下运行时有问题，可能访问磁盘的端口有问题。

> bochs环境配置推荐博客：https://blog.csdn.net/kanshanxd/article/details/130689471?spm=1001.2014.3001.5501
>
> 给第二个磁盘分区的时候使用该命令可达到与书中一样的效果：fdisk -c=dos -u=cylinders hd80M.img

下载os-loongson项目，其中包含os-elephant-dev操作系统，下载好后进入os-loongson中：

```bash
git clone https://github.com/huloves/os-loongson
cd os-loongson
```

> 当前工作目录：os-loongson/

安装可能依赖的命令和包：

```bash
sudo apt install build-essential
sudo apt-get install libghc-x11-dev
sudo apt-get install xorg-dev
```

下载bochs，并解压到os-loongson目录中：

```bash
wget https://udomain.dl.sourceforge.net/project/bochs/bochs/2.6.8/bochs-2.6.8.tar.gz
tar -xvf bochs-2.6.8.tar.gz
```

进入bochs源码目录、配置、编译、安装，安装目录在配置的时候由--prefix参数指定，**注意prefix中写成自己创建的bochs目录绝对路径**。编译过程中肯能出现未安装的依赖包，一般安装后即可。

```bash
cd bochs-2.6.8.tar.gz
./configure --prefix=os-loongson/bochs --enable-debugger --enable-disasm --enable-iodebug --enable-x86-debugger --with-x --with-x11 LDFLAGS='-pthread'
make
make install
```

bochs配置文件示例：

```bash
megs : 32

romimage: file=/home/huloves/repositories/os-loongson/bochs/share/bochs/BIOS-bochs-latest
vgaromimage: file=/home/huloves/repositories/os-loongson/bochs/share/bochs/VGABIOS-lgpl-latest

boot: disk

log: bochs.out

mouse:enabled=0
keyboard:keymap=/home/huloves/repositories/os-loongson/bochs/share/bochs/keymaps/x11-pc-us.map

ata0: enabled=1, ioaddr1=0x1f0, ioaddr2=0x3f0, irq=14
ata0-master: type=disk, path="hd60M.img", mode=flat, cylinders=6, heads=16, spt=63
ata0-slave: type=disk, path="hd80M.img", mode=flat, cylinders=101, heads=16, spt=63
```

## 2 部署工作环境

### 配置qemu运行环境

在os-loongson中创建qemu目录，其中放置需要使用的QEMU。

> QEMU是一个通用的开源机器模拟器和虚拟器。[QEMU Main Documentation](https://www.qemu.org/docs/master/)

开始搭建loongarh架构的qemu运行环境。

下载[qemu-system-loongarch64](https://github.com/Qiubomm-OS/toolchains/releases/download/v0.1/qemu-system-loongarch64)、[loongarch_bios_0310_debug.bin](https://github.com/Qiubomm-OS/toolchains/releases/download/v0.1/loongarch_bios_0310_debug.bin)和[efi-virtio.rom](https://github.com/Qiubomm-OS/toolchains/releases/download/v0.1/efi-virtio.rom)到os-loongson/qemu中。

在os-loongson/qemu.目录下使用下述命令试运行：

```bash
cd qemu
./qemu-system-loongarch64 -m 4G -smp 1 -bios ./loongarch_bios_0310_debug.bin -vga none -nographic
```

> efi-virtio.rom - qemu需要使用的rom file。
>
> loongarch_bios_0310_debug.bin. loongarch架构UEFI bios二进制程序。

试运行截图：

![image-20230819195642027](/Users/huloves/Pictures/image-20230819195642027.png)

### 下载编译工具链

在os-loongson中创建toolchains目录，其中放置需要用到的工具链。

下载工具链包[loongarch64-clfs-6.3-cross-tools-gcc-full.tar.xz](https://github.com/Qiubomm-OS/toolchains/releases/download/v0.1/loongarch64-clfs-6.3-cross-tools-gcc-full.tar.xz)到os-loongson下，并解压到os-loongson/toolchains中，解压命令如下：

```bash
tar -xvf loongarch64-clfs-6.3-cross-tools-gcc-full.tar.xz -C toolchains
```

## 3 龙芯启动部分程序，向内核迈进

从计算机的启动到执行C语言程序大致流程为：1.计算机上电 `->` 2.运行ROM程序（BIOS、UEFI） `->` 3.从ROM程序接管计算机控制，进行初步设置 `->` 4.运行C语言程序。这其中内核编程人员从第3步开始需要编写程序，且这部分代码基本上为直接操作寄存器进行设置，所以一般使用汇编代码编写。当对计算机进行内核所需的初始化之后，跳转到C语言程序部分开始执行后续内容。后续内容中一般只有少部分代码需要直接操作寄存器，所以后续直接操作寄存器的内容一般使用内敛汇编完成。

> 如果后续内容中存在需要大量操作寄存器的部分，也会直接编写汇编程序。例如例外和中断处理、上下文切换。

本章龙芯启动部分程序的内容为：从ROM程序开始接管计算机控制，进行初步设置，然后跳转至C语言程序。C语言程序中使用串口输出功能，输出`hello os-loongson`。

